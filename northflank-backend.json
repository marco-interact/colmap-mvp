{
  "name": "colmap-worker-gpu",
  "description": "COLMAP GPU Worker - 3D Reconstruction Backend",
  "spec": {
    "kind": "Deployment",
    "type": "Service",
    "buildSettings": {
      "dockerfile": {
        "buildEngine": "kaniko",
        "dockerfilePath": "/Dockerfile.northflank",
        "dockerWorkDir": "/app",
        "useCache": true
      }
    },
    "runtimeSettings": {
      "resources": {
        "replicas": {
          "min": 1,
          "max": 3
        },
        "vCPU": {
          "value": 4
        },
        "memory": {
          "value": 8192
        },
        "storage": {
          "ephemeralStorage": {
            "value": 10240
          }
        },
        "gpu": {
          "enabled": true,
          "type": "nvidia-tesla-t4",
          "count": 1
        }
      },
      "ports": [
        {
          "name": "http",
          "internalPort": 8080,
          "public": true,
          "protocol": "HTTP",
          "security": {
            "policies": []
          }
        }
      ],
      "healthChecks": {
        "livenessProbe": {
          "path": "/health",
          "port": 8080,
          "initialDelaySeconds": 60,
          "periodSeconds": 30,
          "timeoutSeconds": 30,
          "failureThreshold": 3
        },
        "readinessProbe": {
          "path": "/readiness",
          "port": 8080,
          "initialDelaySeconds": 30,
          "periodSeconds": 10,
          "timeoutSeconds": 10,
          "failureThreshold": 3
        }
      }
    },
    "environmentVariables": [
      {
        "key": "PORT",
        "value": "8080"
      },
      {
        "key": "COLMAP_CPU_ONLY",
        "value": "false"
      },
      {
        "key": "CUDA_VISIBLE_DEVICES",
        "value": "0"
      },
      {
        "key": "NVIDIA_VISIBLE_DEVICES",
        "value": "all"
      },
      {
        "key": "DATABASE_PATH",
        "value": "/app/data/colmap_app.db"
      },
      {
        "key": "STORAGE_DIR",
        "value": "/app/data/results"
      },
      {
        "key": "CACHE_DIR",
        "value": "/app/cache"
      },
      {
        "key": "MAX_CONCURRENT_JOBS",
        "value": "4"
      }
    ],
    "volumes": [
      {
        "name": "data-volume",
        "path": "/app/data",
        "size": 20480
      },
      {
        "name": "cache-volume",
        "path": "/app/cache",
        "size": 10240
      }
    ]
  }
}

